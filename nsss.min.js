function createMerchmaker(){var e={randomObjectsBaseURL:"http://api.wordnik.com/v4/words.json/randomWords?hasDictionaryDef=false&includePartOfSpeech=noun&excludePartOfSpeech=proper-noun&minCorpusCount=500&maxCorpusCount=-1&minDictionaryCount=1&maxDictionaryCount=-1&minLength=5&maxLength=-1&api_key=4127d30929863bfd6f00b0bf4f805a04980240ddbe2fa0a1d",fallbackObjects:["sweatpants","corn syrup","toilet paper","pipewrench","karate manual","hand sanitizer","sandwich","car battery","grappling hook","harmonica","interior flat paint","milk","mayonnaise"],units:["five-gallon drums","gross","baker's dozens","six-packs","baskets","pcs.","pre-inspected containers","things","refills","variety packs","of them","big ones"],adjectives:["firm","slightly irregular","industrial-strength","cat-friendly","chewy","odorless","economy","deluxe kind","family-size","travel size","shatterproof","refurbished","professional-quality","rechargeable","women's","children's","men's","inflatable","flame retardant","homeopathic","natural","gluten-free","all-wheel drive","hypo-allergenic","convertible","unflavored","special edition","individually wrapped","solid state","Brooklyn-style","elastic waist","high-performance","uncut","bake-n-serve","vegan","fully articulated","blue","vintage","locally grown","petite","fully automatic","lemon scented","free-range","assorted","fleece lined","wi-fi ready","four color","five pocket","extended release","basic","professional","chewable","salted caramel","aerosol","original formula","gentle","complete","extra pulp","washable","oil free","indoor","Swedish","soft","hardcore"],banners:["bonus","gift with purchase","sale","limited time","best seller","new","back in stock","special edition","reduced for quick sale","buy 1 get 1 free","9 for the price of 8"],encouragement:["YISS","Yiss!","That's right, son!","wow such deal","Do it!"],buzzkills:["Negro","Negroes","chink","chinks","gook","gooks","nigger","niggers","spic","spics","rape","rapes","rapist","rapists"]};return e.makeItems=function(e,t){function n(n,i){if(n){console.log(n);for(var o=0;e>o;++o)s.push(this.makeItem(utils.pickFromArrayAtRandom(this.fallbackObjects)))}else s=i.map(this.getWordFromObject.bind(this));t(null,s)}var s=[];utils.getJSONRequest(this.randomObjectsBaseURL+"&limit="+e,1500,n.bind(this))},e.getWordFromObject=function(e){var t=null;return t=-1===this.buzzkills.indexOf(e.word)?this.makeItem(e.word):this.makeItem(utils.pickFromArrayAtRandom(this.fallbackObjects))},e.makeItem=function(e){var t={id:"i"+utils.randomId(8),thing:e},n=~~(5*Math.random());if(3>n){var s=utils.pickFromArrayAtRandom(this.adjectives);t.adjective=s,t.postfixAdjective=n>1}0===~~(2*Math.random())&&(t.quantity=~~(50*Math.random())+1,t.units=utils.pickFromArrayAtRandom(this.units));var i=t.quantity?t.quantity:1,o=~~(100*Math.random());return t.cost=70>o?(30*Math.random()*i).toFixed(2):90>o?((70*Math.random()+30)*i).toFixed(2):99>o?((400*Math.random()+100)*i).toFixed(2):((9500*Math.random()+500)*i).toFixed(2),t},e}function createRouter(){function e(e){for(var t={},n=2;n<e.length;n+=2){var s=null;n+1<e.length&&(s=e[n+1]),t[e[n]]=s}return t}var t={moduleCache:{}};return t.direct=function(t){var n="",s=t.split("/");s.length>1&&(n=s[1]),n||(n="index"),this.directWithOpts(n,e(s))},t.directWithOpts=function(e,t){var n=this.moduleCache[e];if(!n){switch(e){case"all":case"checkit":default:e="all",n=createItemsModule()}this.moduleCache[e]=n}n.opts=t,n.render()},t.respondToHashChange=function(){this.direct(location.hash)},t.syncURLToModule=function(e){var t=location.protocol+"//"+location.host+location.pathname+"#/"+e;window.history.pushState(null,null,t)},t.init=function(){this.direct(location.hash),window.onhashchange=this.respondToHashChange.bind(this)},t.init(),t}function createFlickrSearch(){function e(e){return"http://api.flickr.com/services/rest/?method=flickr.photos.search&api_key=b10e91fcff639f811ac600afb98308f9&text="+e+"&"+"license=1%2C2%2C3%2C4%2C5%2C6%2C7%2C8&per_page=3&"+"format=json&nojsoncallback=1&"}function t(e){return"http://api.flickr.com/services/rest/?method=flickr.photos.getSizes&api_key=b10e91fcff639f811ac600afb98308f9&photo_id="+e+"&"+"format=json&nojsoncallback=1"}var n={};return n.searchImages=function(n,s){function i(e,n){if(e)console.log(e);else if("ok"!==n.stat||n.photos.photo.length<1)console.log("Couldn't find image. Status:",n.stat);else{var s=utils.pickFromArrayAtRandom(n.photos.photo);if(-1!==s.title.indexOf("Historical Bristol Street Directory"))console.log("Filtered spam image.");else{var i=s.id;utils.getJSONRequest(t(i),1e4,o)}}}function o(e,t){e?console.log(e):"ok"!==t.stat?console.log("Couldn't get image. Status:",t.stat):(n.imageURL=t.sizes.size[1].source,s.src=n.imageURL,s.parentElement.classList.add("image-loaded"))}utils.getJSONRequest(e(n.thing),1e4,i)},n}function createItemsModule(){function e(e,s){var i=e.selectAll(".item").data(s,accessors.id),o=i.enter().append("li").classed("item",!0).classed("new",!0);setTimeout(function(){o.classed("new",!1)},400),o.append("div").classed("picture",!0).append("img"),o.append("div").classed("description",!0),o.append("div").classed("cost",!0),o.append("button").classed("share",!0).text("Share!").on("click",n),o.append("button").classed("buy",!0).text("Buy!"),i.selectAll(".picture").select("img").each(t),i.selectAll(".description").html(accessors.getDescriptionHTML),i.selectAll(".cost").text(accessors.cost),i.classed("darker-stripe",function(e,t){return 0===t%2}),i.exit().remove()}function t(e){e.imageURL?this.src=e.imageURL:flickrSearch.searchImages(e,this)}function n(e){s(e)}function s(e){var t=[[{id:"saveItemOp-"+e.id,op:"saveItem",params:e}]];utils.postJSONRequest(r.warehouseURL,JSON.stringify(t),null,function(e,t){console.log(e,t)})}function i(e,t){var n=[[{id:"getItemOp-"+e,op:"getItem",params:{id:e}}]];utils.postJSONRequest(r.warehouseURL,JSON.stringify(n),null,function(e,n){e?t(e):n.length<1||"Got"!==n[0].status?t("Could not get results."):t(null,n[0].value)})}function o(){var e=d3.select("body"),t=e.append("div").classed("drape",!0);return t.append("span").classed("cancel-link",!0).text("Cancel").on("click",function(){a(250)}),t}function a(e){d3.select(".drape").transition().duration(e).style("opacity",0).remove()}var r={numberOfItemsPerLoad:10,cachedItems:[],merchmaker:createMerchmaker(),requestInProgress:!1,warehouseURL:"http://localhost:3001"};return r.init=function(){},r.deactivate=function(){window.onscroll=null},r.render=function(){window.onscroll=this.respondToScroll.bind(this);var e=d3.select(".banner"),t=e.select("img");t.empty()&&(t=e.append("img")),document.body.clientWidth>600?t.attr("src","res/nonstopscrollshop.png"):t.attr("src","res/nonstopscrollshop_320.png"),d3.select(".titlebar").text("Non-Stop Scroll Shop! It's your one-stop non-stop scroll shop!"),this.getItems(),"checkit"in this.opts&&this.highlightItem(this.opts.checkit)},r.renderItems=function(t){d3.selectAll(".root > *").each(function(){var e=d3.select(this);e.classed("items-root")||e.remove()});var n=d3.select(".items-root");n.empty()&&(n=d3.select(".root").append("ul").classed("items-root",!0)),e(n,t)},r.getItems=function(){this.requestInProgress=!0,this.merchmaker.makeItems(10,function(e,t){t.forEach(function(e){this.cachedItems.push(e)}.bind(this)),this.requestInProgress=!1,this.renderItems(r.cachedItems)}.bind(this))},r.respondToScroll=function(){!this.requestInProgress&&document.body.scrollHeight-document.body.scrollTop<=window.innerHeight&&this.getItems()},r.highlightItem=function(t){i(t,function(t,n){if(t)console.log(t);else{var s=o();e(s,[n]),d3.select(".drape .item").style("background-color","hsla("+~~(360*Math.random())+", 43%, 71%, 1)")}})},r.init(),r}var utils=function(){function e(e){return e[~~(Math.random()*e.length)]}function t(e){var t="";return e.length>0&&(t=e.charAt(0).toUpperCase()),e.length>1&&(t+=e.slice(1)),t}function n(t){for(var n="",s=0;t>s;++s)n+=e(o);return n}function s(e,t,n){var s=new XMLHttpRequest;s.open("GET",e),s.setRequestHeader("accept","application/json");var i=null;s.onload=function(){if(clearTimeout(i),200===this.status){var e=JSON.parse(this.responseText);n(null,e)}else n("Error while making request. XHR status: "+this.status,null)},s.send(),t>0&&(i=setTimeout(function(){s.abort(),n("Timed out",null)},t))}function i(e,t,n,s){var i=new XMLHttpRequest;i.open("POST",e),i.setRequestHeader("content-type","application/json");var o=null;i.onload=function(){if(clearTimeout(o),200===this.status){var e=JSON.parse(this.responseText);s(null,e)}else s("Error while making request. XHR status: "+this.status,null)},i.send(t),n>0&&(o=setTimeout(function(){i.abort(),s("Timed out",null)},n))}var o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".split("");return{pickFromArrayAtRandom:e,convertToPoorMansTitleCase:t,randomId:n,getJSONRequest:s,postJSONRequest:i}}(),accessors={id:function(e){return e.id},label:function(e){return e.label},date:function(e){return e.date},localeDate:function(e){var t=new Date(e.date),n=t.toLocaleTimeString();return n=n.replace(/:\d+ /," "),t.toLocaleDateString()+" "+n},description:function(e){return e.description},getDescriptionHTML:function(e){var t="";return t=e.adjective?e.postfixAdjective?'<span class="thing">'+utils.convertToPoorMansTitleCase(e.thing)+'</span>, <span class="adjective">'+e.adjective+"</span>":'<span class="adjective">'+utils.convertToPoorMansTitleCase(e.adjective)+' </span> <span class="thing">'+e.thing+"</span>":'<span class="thing">'+utils.convertToPoorMansTitleCase(e.thing)+"</span>",e.quantity&&(t+='<div class="quantity">'+e.quantity+' <span class="units">'+e.units+"</span></div>"),t},cost:function(e){return"$"+e.cost},thing:function(e){return e.thing},onClick:function(e){return e.click()}},flickrSearch=createFlickrSearch(),theRouter=createRouter();