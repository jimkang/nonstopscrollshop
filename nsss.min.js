function createMerchmaker(){var e={randomObjectsBaseURL:"http://api.wordnik.com/v4/words.json/randomWords?hasDictionaryDef=false&includePartOfSpeech=noun&excludePartOfSpeech=proper-noun&minCorpusCount=500&maxCorpusCount=-1&minDictionaryCount=1&maxDictionaryCount=-1&minLength=5&maxLength=-1&api_key=4127d30929863bfd6f00b0bf4f805a04980240ddbe2fa0a1d",fallbackObjects:["sweatpants","corn syrup","toilet paper","pipewrench","karate manual","hand sanitizer","sandwich","car battery","grappling hook","harmonica","interior flat paint","milk","mayonnaise"],units:["five-gallon drums","gross","baker's dozens","six-packs","baskets","pcs.","pre-inspected containers","things","refills","variety packs","of them","big ones"],adjectives:["firm","slightly irregular","industrial-strength","cat-friendly","chewy","odorless","economy","deluxe kind","family-size","travel size","shatterproof","refurbished","professional-quality","rechargeable","women's","children's","men's","inflatable","flame retardant","homeopathic","natural","gluten-free","all-wheel drive","hypo-allergenic","convertible","unflavored","special edition","individually wrapped","solid state","Brooklyn-style","elastic waist","high-performance","uncut","bake-n-serve","vegan","fully articulated","blue","vintage","locally grown","petite","fully automatic","lemon scented","free-range","assorted","fleece lined","wi-fi ready","four color","five pocket","extended release","basic","professional","chewable","salted caramel","aerosol","original formula","gentle","complete","extra pulp","washable","oil free","indoor","Swedish","soft","hardcore"],banners:["bonus","gift with purchase","sale","limited time","best seller","new","back in stock","special edition","reduced for quick sale","buy 1 get 1 free","9 for the price of 8"],encouragement:["YISS","Yiss!","That's right, son!","wow such deal","Do it!"],buzzkills:["Negro","Negroes","chink","chinks","gook","gooks","nigger","niggers","spic","spics","rape","rapes","rapist","rapists"]};return e.makeItems=function(e,t){function s(s,i){if(s){console.log(s);for(var o=0;e>o;++o)n.push(this.makeItem(utils.pickFromArrayAtRandom(this.fallbackObjects)))}else n=i.map(this.getWordFromObject.bind(this));t(null,n)}var n=[];utils.getJSONRequest(this.randomObjectsBaseURL+"&limit="+e,1500,s.bind(this))},e.getWordFromObject=function(e){var t=null;return t=-1===this.buzzkills.indexOf(e.word)?this.makeItem(e.word):this.makeItem(utils.pickFromArrayAtRandom(this.fallbackObjects))},e.makeItem=function(e){var t={id:"i"+utils.randomId(8),thing:e},s=~~(5*Math.random());if(3>s){var n=utils.pickFromArrayAtRandom(this.adjectives);t.adjective=n,t.postfixAdjective=s>1}0===~~(2*Math.random())&&(t.quantity=~~(50*Math.random())+1,t.units=utils.pickFromArrayAtRandom(this.units));var i=t.quantity?t.quantity:1,o=~~(100*Math.random());return t.cost=70>o?(30*Math.random()*i).toFixed(2):90>o?((70*Math.random()+30)*i).toFixed(2):99>o?((400*Math.random()+100)*i).toFixed(2):((9500*Math.random()+500)*i).toFixed(2),t},e}function createRouter(){function e(e){for(var t={},s=2;s<e.length;s+=2){var n=null;s+1<e.length&&(n=e[s+1]),t[e[s]]=n}return t}var t={moduleCache:{}};return t.direct=function(t){var s="",n=t.split("/");n.length>1&&(s=n[1]),s||(s="index"),this.directWithOpts(s,e(n))},t.directWithOpts=function(e,t){var s=this.moduleCache[e];if(!s){switch(e){case"all":case"checkit":default:e="all",s=createItemsModule()}this.moduleCache[e]=s}s.opts=t,s.render()},t.respondToHashChange=function(){this.direct(location.hash)},t.syncURLToModule=function(e){var t=location.protocol+"//"+location.host+location.pathname+"#/"+e;window.history.pushState(null,null,t)},t.init=function(){this.direct(location.hash),window.onhashchange=this.respondToHashChange.bind(this)},t.init(),t}function createFlickrSearch(){function e(e){return"http://api.flickr.com/services/rest/?method=flickr.photos.search&api_key=b10e91fcff639f811ac600afb98308f9&text="+e+"&"+"license=1%2C2%2C3%2C4%2C5%2C6%2C7%2C8&per_page=3&"+"format=json&nojsoncallback=1&"}function t(e){return"http://api.flickr.com/services/rest/?method=flickr.photos.getSizes&api_key=b10e91fcff639f811ac600afb98308f9&photo_id="+e+"&"+"format=json&nojsoncallback=1"}var s={};return s.searchImages=function(s,n){function i(e,i){if(e)console.log(e);else if("ok"!==i.stat||i.photos.photo.length<1)console.log("Couldn't find image. Status:",i.stat);else{var a=utils.pickFromArrayAtRandom(i.photos.photo);if(-1!==a.title.indexOf("Historical Bristol Street Directory"))console.log("Filtered spam image.");else{s.imageAttribution="http://www.flickr.com/photos/"+a.owner+"/"+a.id,n.href=s.imageAttribution,n.target="_blank";var r=a.id;utils.getJSONRequest(t(r),1e4,o)}}}function o(e,t){if(e)console.log(e);else if("ok"!==t.stat)console.log("Couldn't get image. Status:",t.stat);else{var i=t.sizes.size[1],o=d3.select(n).select("img");s.imageURL=i.source,o.attr("src",s.imageURL),n.parentElement.classList.add("image-loaded")}}utils.getJSONRequest(e(s.thing),1e4,i)},s}function createItemsModule(){function e(e,n){var i=e.selectAll(".item").data(n,accessors.id),o=i.enter().append("li").classed("item",!0).classed("new",!0);setTimeout(function(){o.classed("new",!1)},400),o.append("div").classed("picture",!0).append("a").append("img"),o.append("div").classed("description",!0),o.append("div").classed("cost",!0),o.append("button").classed("share",!0).text("Share!").on("click",s),o.append("button").classed("buy",!0).text("Buy!"),i.selectAll(".picture").select("a").each(t),i.selectAll(".description").html(accessors.getDescriptionHTML),i.selectAll(".cost").text(accessors.cost),i.classed("darker-stripe",function(e,t){return 0===t%2}),i.exit().remove()}function t(e){e.imageAttribution&&(this.href=e.imageAttribution);var t=d3.select(this).select("img");e.imageURL?t.attr("src",e.imageURL):flickrSearch.searchImages(e,this)}function s(e){n(e);var t=location.protocol+"//"+location.host+"/#/items/checkit/"+e.id,s="Great deal on @nonstopscrshop! "+accessors.description(e)+" "+t,i="http://twitter.com/intent/tweet?text="+encodeURIComponent(s);window.open(i,"_blank")}function n(e){var t=[[{id:"saveItemOp-"+e.id,op:"saveItem",params:e}]];utils.postJSONRequest(r.warehouseURL,JSON.stringify(t),null,function(e,t){console.log(e,t)})}function i(e,t){var s=[[{id:"getItemOp-"+e,op:"getItem",params:{id:e}}]];utils.postJSONRequest(r.warehouseURL,JSON.stringify(s),null,function(e,s){e?t(e):s.length<1||"Got"!==s[0].status?t("Could not get results."):t(null,s[0].value)})}function o(){var e=d3.select("body"),t=e.append("div").classed("drape",!0);return t}function a(e){d3.select(".drape").transition().duration(e).style("opacity",0).remove()}var r={numberOfItemsPerLoad:10,cachedItems:[],merchmaker:createMerchmaker(),requestInProgress:!1,warehouseURL:"http://localhost:3001"};return r.init=function(){},r.deactivate=function(){window.onscroll=null},r.render=function(){window.onscroll=this.respondToScroll.bind(this);var e=d3.select(".banner"),t=e.select("img");t.empty()&&(t=e.append("img")),document.body.clientWidth>600?t.attr("src","res/nonstopscrollshop.png"):t.attr("src","res/nonstopscrollshop_320.png"),d3.select(".titlebar").text("Non-Stop Scroll Shop! It's your one-stop non-stop scroll shop!"),this.getItems(),"checkit"in this.opts&&this.highlightItem(this.opts.checkit)},r.renderItems=function(t){d3.selectAll(".root > *").each(function(){var e=d3.select(this);e.classed("items-root")||e.remove()});var s=d3.select(".items-root");s.empty()&&(s=d3.select(".root").append("ul").classed("items-root",!0)),e(s,t)},r.getItems=function(){this.requestInProgress=!0,this.merchmaker.makeItems(10,function(e,t){t.forEach(function(e){this.cachedItems.push(e)}.bind(this)),this.requestInProgress=!1,this.renderItems(r.cachedItems)}.bind(this))},r.respondToScroll=function(){!this.requestInProgress&&document.body.scrollHeight-document.body.scrollTop<=window.innerHeight&&this.getItems()},r.highlightItem=function(t){i(t,function(t,s){if(t)console.log(t);else{var n=o();e(n,[s]);var i=d3.select(".drape .item");i.style("background-color","hsla("+~~(360*Math.random())+", 43%, 71%, 1)");var r=i.node(),c=r.offsetLeft+r.offsetWidth,l=r.offsetTop,u=n.append("svg").attr({width:64,height:64}).style({position:"absolute",left:c-32,top:l-32});u.append("path").attr({d:d3.svg.symbol().type("cross").size(1024),fill:"#fff",transform:"translate(32, 32) rotate(45)"}).classed("shadowed",!0),u.on("click",function(){a(250)})}})},r.init(),r}var utils=function(){function e(e){return e[~~(Math.random()*e.length)]}function t(e){var t="";return e.length>0&&(t=e.charAt(0).toUpperCase()),e.length>1&&(t+=e.slice(1)),t}function s(t){for(var s="",n=0;t>n;++n)s+=e(o);return s}function n(e,t,s){var n=new XMLHttpRequest;n.open("GET",e),n.setRequestHeader("accept","application/json");var i=null;n.onload=function(){if(clearTimeout(i),200===this.status){var e=JSON.parse(this.responseText);s(null,e)}else s("Error while making request. XHR status: "+this.status,null)},n.send(),t>0&&(i=setTimeout(function(){n.abort(),s("Timed out",null)},t))}function i(e,t,s,n){var i=new XMLHttpRequest;i.open("POST",e),i.setRequestHeader("content-type","application/json");var o=null;i.onload=function(){if(clearTimeout(o),200===this.status){var e=JSON.parse(this.responseText);n(null,e)}else n("Error while making request. XHR status: "+this.status,null)},i.send(t),s>0&&(o=setTimeout(function(){i.abort(),n("Timed out",null)},s))}var o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".split("");return{pickFromArrayAtRandom:e,convertToPoorMansTitleCase:t,randomId:s,getJSONRequest:n,postJSONRequest:i}}(),accessors={id:function(e){return e.id},label:function(e){return e.label},date:function(e){return e.date},localeDate:function(e){var t=new Date(e.date),s=t.toLocaleTimeString();return s=s.replace(/:\d+ /," "),t.toLocaleDateString()+" "+s},description:function(e){var t="";return t=e.adjective?e.postfixAdjective?utils.convertToPoorMansTitleCase(e.thing)+", "+e.adjective:utils.convertToPoorMansTitleCase(e.adjective)+" "+e.thing:utils.convertToPoorMansTitleCase(e.thing),e.quantity&&(t+=": "+e.quantity+" "+e.units),t},getDescriptionHTML:function(e){var t="";return t=e.adjective?e.postfixAdjective?'<span class="thing">'+utils.convertToPoorMansTitleCase(e.thing)+'</span>, <span class="adjective">'+e.adjective+"</span>":'<span class="adjective">'+utils.convertToPoorMansTitleCase(e.adjective)+' </span> <span class="thing">'+e.thing+"</span>":'<span class="thing">'+utils.convertToPoorMansTitleCase(e.thing)+"</span>",e.quantity&&(t+='<div class="quantity">'+e.quantity+' <span class="units">'+e.units+"</span></div>"),t},cost:function(e){return"$"+e.cost},thing:function(e){return e.thing},onClick:function(e){return e.click()}},flickrSearch=createFlickrSearch(),theRouter=createRouter();